# Protobuf    -*- sh -*-

PROTOBUF_VERSION="2.5.0"
PROTOBUF_DOWNLOAD_URL="https://protobuf.googlecode.com/files/protobuf-2.5.0.tar.bz2"

if [ "" != "${JOB_NAME}" ] ; then
  WHERE=$(cd ../.. ; pwd)        # Useful on CI to escape dir with spaces
else
  WHERE="${ROOT_DIR}"
fi

PROTOBUF_HOME="${WHERE}/protobuf-${PROTOBUF_VERSION}"


protobuf_check() {
  ls ${PROTOBUF_HOME} >/dev/null 2>&1
}

protobuf_install() {
  if protobuf_check ; then
    echo "Protobuf already installed"
  else
    cd "${WHERE}"
    rm -rf protobuf-${PROTOBUF_VERSION}/
    rm -rf /tmp/protobuf*

    echo "Downloading Protobuf..."
    if [ ! -f  protobuf-${PROTOBUF_VERSION}.tar.bz2 ] ; then
       curl -k -O ${PROTOBUF_DOWNLOAD_URL}
    fi
    tar xvf protobuf-${PROTOBUF_VERSION}.tar.bz2
    cd protobuf-${PROTOBUF_VERSION}
    export PROTOBUF_HOME="${PWD}"

    #
    # Note: protobuf has problem compiling from directories including
    # spaces in their path. e.g. CI.
    #
    ./configure
    make

    remember "PROTOBUF_HOME" "${PROTOBUF_HOME}"
    export PROTOBUF_HOME

    PATH=${PATH}:${PROTOBUF_HOME}/src
    export PATH
    remember "PATH" '${PATH}:${PROTOBUF_HOME}/src'
  fi
}

protobuf_uninstall() {
  rm -rf "${PROTOBUF_HOME}"
}

protobuf_status() {
  cd "${PROTOBUF_HOME}"
  echo "status; quit" | ./bin/protobuf shell
}

protobuf_start() {
  cd "${PROTOBUF_HOME}"
  rm -rf /tmp/protobuf*
  ./bin/start-protobuf.sh
}

protobuf_stop() {
  cd "${PROTOBUF_HOME}"
  ./bin/stop-protobuf.sh
}

protobuf_restart() {
  protobuf_stop
  protobuf_start
}
