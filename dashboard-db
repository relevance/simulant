# Dashboard DB Setup   -*- sh -*-

if [ "" != "${JOB_NAME}" ] ; then
  DASHBOARD_DB_NAME=dashboard_ci_dev_$(echo "${JOB_NAME}" | tr '[:upper:]' '[:lower:]' | sed -E 's/[^a-z0-9]//g')
  DASHBOARD_DB_HOST="rds.runa.com"
  DASHBOARD_DB_USER=dashboard
  DASHBOARD_DB_PASSWORD="uCheic5uGae9IfooBoong3yuaebaePh8"
else
  DASHBOARD_DB_NAME="runa_dashboard_development"
  DASHBOARD_DB_HOST="localhost"
  DASHBOARD_DB_USER="root"
  DASHBOARD_DB_PASSWORD="retold-fever"
fi

dashboard_db_check() {
  echo 'select count(*) from users;' | mysql -h "${DASHBOARD_DB_HOST}" -u "${DASHBOARD_DB_USER}" --password="${DASHBOARD_DB_PASSWORD}" "${DASHBOARD_DB_NAME}" >/dev/null && ls config/database.yml >/dev/null
}

dashboard_db_install() {
  if dashboard_db_check ; then
    echo "db already installed"
  else
    cd "${ROOT_DIR}/dashboard"
    mysql_restart
    sleep 10

    if [ "" != "${JOB_NAME}" ] ; then
      cp -f config/database.ci.yml config/database.yml
    else
      cp -f config/database.example.yml config/database.yml
    fi
    rake db:drop
    rake db:create
    rake db:migrate

    if [ "" != "${JOB_NAME}" ] ; then
        rake db:drop RAILS_ENV=test
        rake db:create RAILS_ENV=test
        rake db:migrate RAILS_ENV=test
    fi

    rake data:mock:reset
  fi
}

dashboard_db_uninstall() {
  if [ "" != "${JOB_NAME}" ] ; then
    mysql_restart
  fi
  sleep 10

  cp -f config/database.example.yml config/database.yml
  rake db:drop
  if [ "" != "${JOB_NAME}" ] ; then
    rake db:drop RAILS_ENV=test
  fi
}

dashboard_db_status() {
  echo
}

dashboard_db_start() {
  echo
}

dashboard_db_stop() {
  echo
}
