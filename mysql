# MySQL     -*- sh -*-

case $PKG in
brew) mysql_pkg=mysql ;;
macport) mysql_pkg=mysql55-server ;;
esac

mysql_check() {
  ${PKG}_check ${mysql_pkg}
}

mysql_uninstall() {
  mysqladmin -u root --password=retold-fever shutdown
  mysqladmin -u root shutdown

  ${PKG}_uninstall ${mysql_pkg}

  if [ $PKG = "brew" ] ; then
    sudo rm -rf /usr/local/var/mysql
    sudo rm -f /etc/my.cnf
    sudo rm -f /tmp/mysql.sock
  fi
}

mysql_install() {
  if ${PKG}_check ${mysql_pkg} ; then
    echo "MySQL already installed"
  else
    ${PKG}_install ${mysql_pkg}
    who=`whoami`
    if [ $PKG = "brew" ] ; then
      sudo chown -R "${who}" /usr/local/var/mysql
      sudo chown -R "${who}" /usr/local/opt/mysql
      unset TMPDIR
      mysql_install_db --verbose --user=`whoami` --basedir="$(brew --prefix mysql)" --datadir=/usr/local/var/mysql --tmpdir=/tmp
      sudo chown -R "${who}" /usr/local/var/mysql

      /usr/local/bin/mysqladmin -u root --password=retold-fever shutdown
      /usr/local/bin/mysqladmin -u root shutdown
      pkill -fl mysql
      pkill -9 -fl mysql

      /usr/local/opt/mysql/bin/mysqld_safe &
      sleep 5

      /usr/local/bin/mysqladmin -u root password 'retold-fever'
      /usr/local/bin/mysqladmin -u root --password=retold-fever -h localhost password 'retold-fever'
      /usr/local/bin/mysqladmin -u root --password=retold-fever shutdown
    elif [ $PKG = "macport" ] ; then
      sudo -u mysql /opt/local/lib/mysql55/bin/mysql_install_db
      cnf=/opt/local/etc/mysql55/macports-default.cnf
      sudo cp ${cnf} ${cnf}.original
      sudo chmod 666 ${cnf}
      sudo chmod 666 ${cnf}.original
      awk '{ if ($0 ~ /skip-networking/) { print "# skip-networking" } else { print }  }' ${cnf}.original  > ${cnf}

      sudo -u mysql /opt/local/lib/mysql55/bin/mysqld &
      sleep 5

      sudo -u mysql /opt/local/lib/mysql55/bin/mysqladmin -u root password 'retold-fever'
      sudo -u mysql /opt/local/lib/mysql55/bin/mysqladmin -u root --password=retold-fever -h localhost password 'retold-fever'
      sudo -u mysql /opt/local/lib/mysql55/bin/mysqladmin -u root --password=retold-fever shutdown
    fi
  fi
}

mysql_status() {
  mysqladmin ping
}

mysql_start() {
  if [ $PKG = "brew" ] ; then
    if [ 0 -eq $fg ] ; then
      /usr/local/bin/mysqld_safe &
    else
      /usr/local/bin/mysqld_safe
    fi
  elif [ $PKG = "macport" ] ; then
    if [ 0 -eq $fg ] ; then
      sudo -u mysql /opt/local/lib/mysql55/bin/mysqld &
    else
      sudo -u mysql /opt/local/lib/mysql55/bin/mysqld
    fi
  fi
}

mysql_stop() {
  if [ $PKG = "brew" ] ; then
    mysqladmin -u root --password=retold-fever shutdown
  elif [ $PKG = "macport" ] ; then
    sudo -u mysql /opt/local/lib/mysql55/bin/mysqladmin -u root --password=retold-fever shutdown
  fi
}

mysql_restart() {
    mysql_stop
    mysql_start
}
